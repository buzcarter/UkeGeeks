var ugsEditorPlus=window.ugsEditorPlus||{};;ugsEditorPlus.options={useLegacyIe:false,showEditOnLoad:true,fontSize:12,diagramSize:100,diagramPosition:"left",lyricStyle:"above",paper:"letter",theme:"normal",tuning:"soprano",hideChordEnclosures:false,sortAlphabetical:false,ignoreCommonChords:false,commonChords:[]};;ugsEditorPlus.actions=(function(){var _public={};var _ele={};var _song=null;var _originalSource=null;var _originalChords=[];var _regEx={safe:/^([A-G][#b]?)(m|m6|7|m7|dim|maj7|6|sus2|sus4|aug|9)?$/};var _prevValues={'placement':'above','transpose':'up_0'};_public.init=function(){_ele={songText:document.getElementById('ukeSongText'),songContainer:document.getElementById('ukeSongContainer'),cpmSource:document.getElementById('chordProSource'),scalableArea:document.getElementById('scalablePrintArea')};$(document).on('option:click',function(e,data){doAction(data.action,data.value);});syncOptions(ugsEditorPlus.options);};var doAction=function(action,value){var runRequired=false;switch(action){case'zoomFonts':doSetFontSize(value);break;case'zoomDiagrams':doSetDiagramSize(value);break;case'layout':doLayout(value);break;case'placement':runRequired=doPlacement(value);break;case'tuning':doTuning(value);runRequired=true;break;case'colors':doSetTheme(value);runRequired=true;break;case'transpose':doTranspose(value);break;case'paper':doSetPageWidth(value);break;case'showEnclosures':setEnclosureVisible(value);runRequired=true;break;case'hideCommonChords':setIgnoreCommon(value);runRequired=true;break;case'sortAlphabetical':setSortAlphabetical(value);runRequired=true;break;case'setCommonChords':setCommonChordsList(value);runRequired=ukeGeeks.settings.opts.ignoreCommonChords;break;case'update':doUpdate();break;default:console.log('Unrecognized '+action+' > '+value);}
if(runRequired){_public.run();}};var syncOptions=function(options){doSetFontSize(options.fontSize);doSetDiagramSize(options.diagramSize);doLayout(options.diagramPosition);doSetPageWidth(options.paper);doSetTheme(options.theme);doTuning(options.tuning);doPlacement(options.lyricStyle);setEnclosureVisible(!options.hideChordEnclosures);setIgnoreCommon(options.ignoreCommonChords);setCommonChordsList(options.commonChords);setSortAlphabetical(options.sortAlphabetical);};var doUpdate=function(){_public.run(true);};_public.run=function(isDoBackup){isDoBackup=(arguments.length>0)&&isDoBackup;_ele.songText.innerHTML='<pre>'+_ele.cpmSource.value+'</pre>';_song=ukeGeeks.scriptasaurus.run();if(_song.chords.length<1){ugsEditorPlus.autoReformat.run(_ele);}
if(_song){ugsEditorPlus.songUi.update(_song);if(isDoBackup||(_originalSource===null)){_originalSource=_ele.cpmSource.value;_originalChords=_song.chords;var key=_song.key!==''?_song.key:(_song.chords.length<1?'':_song.chords[0]);resetTranspose(key);}}};var doSetFontSize=function(value){var pt=parseFloat(value,10);_ele.scalableArea.style.fontSize=pt+'pt';};var doSetDiagramSize=function(value){var prct=parseInt(value,10)/100;var columnWidth=Math.round(prct*225);var s=ugsEditorPlus.styles.getSheet('ugsEditorCss');var m=s.find('.scalablePrintArea .ugs-diagrams-wrap canvas');m.style.width=Math.round(prct*ukeGeeks.settings.fretBox.width)+'px';m.style.height=Math.round(prct*ukeGeeks.settings.fretBox.height)+'px';m=s.find('.scalablePrintArea .ugs-diagrams-wrap');m.style.width=columnWidth+'px';m=s.find('.scalablePrintArea .ugs-source-wrap');m.style.marginLeft=(25+columnWidth)+'px';};var doLayout=function(value){$('body').toggleClass('diagramsOnTop',value=='top').toggleClass('diagramsOnSide',value=='left').toggleClass('ugsHideDiagrams',value=='none');};var doPlacement=function(value){var isRunRequired=false;ukeGeeks.toolsLite.setClass(_ele.songContainer,'ugsInline',(value=='inline'));var isMiniDiagrams=(value=='miniDiagrams');if(!isMiniDiagrams){ukeGeeks.toolsLite.removeClass(_ele.songContainer,'ugsInlineDiagrams');}
if(isMiniDiagrams||(_prevValues.placement=='miniDiagrams')){ukeGeeks.settings.inlineDiagrams=isMiniDiagrams;isRunRequired=true;}
else if(!isMiniDiagrams&&(_prevValues.placement!='miniDiagrams')){ukeGeeks.overlapFixer.Fix(_ele.songText);}
_prevValues.placement=value;return isRunRequired;};var doSetTheme=function(value){ugsEditorPlus.themes.set(value);};var doSetPageWidth=function(value){var opts=['letter','a4','screen'];var $body=$('body');for(var i=0;i<opts.length;i++){$body.removeClass('pageWidth_'+opts[i]);}
$body.addClass('pageWidth_'+value);};var doTuning=function(value){var tuning=ukeGeeks.definitions.instrument.sopranoUke,msg='<strong>GCEA</strong> Standard Ukulele';if(value=='baritone'){tuning=ukeGeeks.definitions.instrument.baritoneUke;msg='<strong>DGBE</strong> Baritone Ukulele';}
if(value=='alternate'){tuning=ukeGeeks.definitions.instrument.alternateUke;msg='<strong>ADF#B</strong> alternate';}
$('#footTuningInfo').html(msg);ukeGeeks.scriptasaurus.setTuningOffset(tuning);};var doTranspose=function(value){var sign=value[0]=='u'?1:-1;var steps=parseInt(value[value.length-1],10);transpose(sign*steps);};var transpose=function(steps){var safeChords=[],bad='',i;for(i=0;i<_originalChords.length;i++){if(_regEx.safe.test(_originalChords[i])){safeChords.push(_originalChords[i]);}
else{bad+=_originalChords[i]+', ';}}
if(bad.length>0){if(!confirm('Sorry, but some of your chords can\'t be transposed:\n'+bad+'\n\nDo you want to continue anyway?')){return;}}
var newChords=ukeGeeks.transpose.shiftChords(safeChords,steps);var s=_originalSource;var rEx;for(i=0;i<safeChords.length;i++){rEx=new RegExp('\\['+safeChords[i]+'\\]','g');s=s.replace(rEx,'[ugsxx_'+i+']');}
for(i=0;i<newChords.length;i++){rEx=new RegExp('\\[ugsxx_'+i+'\\]','g');s=s.replace(rEx,'['+newChords[i]+']');}
rEx=/^\s*\{\s*(key|k)\s*:\s*(\S*?)\s*\}\s*$/im;if(rEx.test(s)){var m=s.match(rEx);var key=m[2];if((key!=='')&&_regEx.safe.test(key)){s=s.replace(rEx,m[0].replace(key,ukeGeeks.transpose.shift(key,steps)));}}
_ele.cpmSource.value=s;_public.run();};var resetTranspose=function(keyChord){var ul=document.getElementById('transposeOptions');var items=ul.getElementsByTagName('li');var sample;var steps=-6;_prevValues['transpose']='up_0';ugsEditorPlus.submenuUi.resetTransposeLabel();for(var i=0;i<items.length;i++){ukeGeeks.toolsLite.removeClass(items[i],'checked');sample=(keyChord.length<1)?'':ukeGeeks.transpose.shift(keyChord,steps);items[i].getElementsByTagName('em')[0].innerHTML=sample;if(steps===0){ukeGeeks.toolsLite.addClass(items[i],'checked');}
steps++;}};var setEnclosureVisible=function(isVisible){ukeGeeks.settings.opts.retainBrackets=isVisible;};var setSortAlphabetical=function(isAlphabetical){ukeGeeks.settings.opts.sortAlphabetical=isAlphabetical;};var setIgnoreCommon=function(isIgnore){ukeGeeks.settings.opts.ignoreCommonChords=isIgnore;};var setCommonChordsList=function(chordList){if(typeof chordList=='string'){var inputList=chordList.split(/[ ,]+/);var cleanList=[];for(var i=0;i<inputList.length;i++){var c=ukeGeeks.toolsLite.trim(inputList[i]);if(c.length>0){cleanList.push(c);}}
chordList=cleanList;}
ukeGeeks.settings.commonChords=chordList;};return _public;}());;ugsEditorPlus.songUi=(function(){var _public={};var trySet=function(id,value){var hasValue=value&&(value.length>0);var h=document.getElementById(id);if(!h){return;}
h.innerHTML=hasValue?value:"";h.style.display=hasValue?'block':'none';};_public.update=function(song){var h=document.getElementById('songTitle');h.innerHTML=(song.title.length>0)?song.title:'Untitled-Song';trySet('songArtist',song.artist);trySet('songAlbum',song.album);trySet('songSubtitle',song.st);h=document.getElementById('songMeta');if(!song.ugsMeta||(song.ugsMeta.length<1)){h.style.display='none';}
else{var s='';for(var i=0;i<song.ugsMeta.length;i++){s+='<p>'+song.ugsMeta[i]+'</p>';}
h.innerHTML=s;h.style.display='block';}};return _public;}());;ugsEditorPlus.styles=(function(){var _public={Rules:null};var _sheet=null;_public.getSheet=function(title){_sheet=_getSheet(title);_public.Rules=_getRules();return this;};var _getSheet=function(title){for(var i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].title==title){return document.styleSheets[i];}}
return null;};var _getRules=function(){if(_sheet==null){return[];}
return _sheet.cssRules?_sheet.cssRules:_sheet.rules;};_public.find=function(selector){selector=selector.toLowerCase();for(var i=0;i<_public.Rules.length;i++){if(!_public.Rules[i].selectorText){continue;}
if(_public.Rules[i].selectorText.toLowerCase()==selector){return _public.Rules[i];}}
return null;};return _public;}());;ugsEditorPlus.themes=(function(){var _public={};var _colorSchemes={'normal':{name:'Normal (white paper)',selectText:'Normal colors (white paper)',description:'Simple, legible text on white paper',song:{fretLines:'#003366',dots:'#ff0000',dotText:'#ffffff',text:'#000000',fretText:'#4a4a4a'},tabs:{lines:'#999999',dots:'#eaeaea',text:'#000000'}},'reversed':{name:'Reversed for projectors',selectText:'Reversed colors (for projectors)',description:'Light text on dark background',song:{fretLines:'#365F70',dots:'#FDD96F',dotText:'#000000',text:'#FF6040',fretText:'#999999'},tabs:{lines:'#365F70',dots:'#FDD96F',text:'#000000'}},'frosty':{name:'Frostcicle',selectText:'Frostcicle (cool blue)',description:'Brrrr... icy cool blues',song:{fretLines:'#66B4CC',dots:'#332335',dotText:'#9FE1F9',text:'#0896FE',fretText:'#E3D8BA'},tabs:{lines:'#6699FF',dots:'#EFFCF9',text:'#00558E'}},'jellyBean':{name:'Jelly Beans',selectText:'Jelly Beans (vibrant)',description:'Sugary, vibrant bowl of jelly beans!',song:{fretLines:'#49BC45',dots:'#FF9417',dotText:'#FCF49F',text:'#D20070',fretText:'#4a4a4a'},tabs:{lines:'#6699FF',dots:'#FFF9BA',text:'#75003E'}},'justBlack':{name:'Just Black',selectText:'Black (for laser printers)',description:'No color, but black, best for B&W laser printers',song:{fretLines:'#cccccc',dots:'#000000',dotText:'#ffffff',text:'#000000',fretText:'#000000'},tabs:{lines:'#cccccc',dots:'#000000',text:'#ffffff'}},'krampus':{name:'Gruss vom Krampus',selectText:'Krampus (Ye Olde Christmas)',description:'Seasons Greetin\'s, Happy Holidays, Merry Christmas, Krampus Nichte!',song:{fretLines:'#929867',dots:'#A22C27',dotText:'#EBD592',text:'#4F2621',fretText:'#4a4a4a'},tabs:{lines:'#B69C01',dots:'#E1EEC8',text:'#75003E'}},'western':{name:'Out West',selectText:'Out West (dust country)',description:'Dusty Honky Tonk/Country/Western look',song:{fretLines:'#B5A679',dots:'#CF8300',dotText:'#ffffff',text:'#386571',fretText:'#4a4a4a'},tabs:{lines:'#697665',dots:'#F1E3C5',text:'#632424'}},'pumpkin':{name:'Pumpkin Pie',selectText:'Pumpkin Pie (fall colors)',description:'Fall \'n Halloween \'n Jack o\'Lantern \'n Thanksgiving Fun',song:{fretLines:'#8E9A6C',dots:'#DA6328',dotText:'#FFEE4A',text:'#68391D',fretText:'#B14623'},tabs:{lines:'#BED379',dots:'#FFF4D8',text:'#B14623'}},'notebook':{name:'Rock Notebook',selectText:'Rock Notebook (marker)',description:'A strong, hand-scrawled, and edgily unreliable look',song:{fretLines:'#747CAD',dots:'#1C0866',dotText:'#ffffff',text:'#B22000',fretText:'#A4A0B2'},tabs:{lines:'#A4A0B2',dots:'#F1E3C5',text:'#2E2ECC'}},'zombie':{name:'Zombies!!!',selectText:'Zombies!!!',description:'Blood \'n gore for Halloween',song:{fretLines:'#9EB036',dots:'#E52501',dotText:'#FEDA79',text:'#798666',fretText:'#B14623'},tabs:{lines:'#602749',dots:'#F7F9EA',text:'#4F5F3E'}}};var setBody=function(themeName){var $body=$('body');for(var key in _colorSchemes){if(_colorSchemes.hasOwnProperty(key)){$body.removeClass('theme-'+key);}}
$body.addClass('theme-'+themeName);};_public.getDescription=function(themeName){return _colorSchemes[themeName].selectText;};_public.loadList=function(selector,selectedValue){var s='';for(var key in _colorSchemes){if(_colorSchemes.hasOwnProperty(key)){var cssClass=(key==selectedValue)?'checked':'';s+='<li class="'+cssClass+'"><a href="#'+key+'" title="'+_colorSchemes[key].description+'">'+_colorSchemes[key].name+'</a></li>';}}
$(selector).html(s);};_public.set=function(themeName){setBody(themeName);var c=_colorSchemes[themeName];ukeGeeks.settings.colors=c.song;ukeGeeks.settings.tabs.lineColor=c.tabs.lines;ukeGeeks.settings.tabs.dotColor=c.tabs.dots;ukeGeeks.settings.tabs.textColor=c.tabs.text;};return _public;}());;ugsEditorPlus.optionsDlg=(function(){var _public={};_public.init=function(){var ele,options=ugsEditorPlus.options;document.getElementById('updateBtn').onclick=function(){triggerNotify('update','');return false;};ele=document.getElementById('chkEnclosures');ele.checked=options.hideChordEnclosures;ele.onclick=function(){triggerNotify('showEnclosures',!this.checked);};ele=document.getElementById('commonChordList');ele.value=(typeof options.commonChords=='string')?options.commonChords:options.commonChords.join(", ");ele.onchange=function(){triggerNotify('setCommonChords',this.value);};ele=document.getElementById('chkSortAlpha');if(ele){ele.checked=options.sortAlphabetical;ele.onclick=function(){triggerNotify('sortAlphabetical',this.checked);};}
ele=document.getElementById('chkIgnoreCommon');ele.checked=options.ignoreCommonChords;ele.onclick=function(){triggerNotify('hideCommonChords',this.checked);};$('.checkboxBlock label, input[type=checkbox]').click(function(e){e.stopPropagation();});$('.overlay').draggable({handle:'hgroup'});};var triggerNotify=function(action,value){$.event.trigger('option:click',{action:action,value:value});};return _public;}());;var ugsEditorPlus=window.ugsEditorPlus||{};ugsEditorPlus.reformat=(function(){var _public={};var _hasChords=false;var _enums={lineTypes:{blank:0,chords:1,lyrics:2,tabs:3}};var LineObj=function(){this.source='';this.wordCount=0;this.spaceCount=0;this.words=[];this.chordCount=0;this.lineType=_enums.lineTypes.blank;};var _re={words:/\b(\S+)\b/gi,spaces:/(\s+)/g,leadingSpace:/(^\s+)/,chordNames:/\b[A-G][#b]?(m|m6|m7|m9|dim|dim7|maj7|sus2|sus4|aug|6|7|9|add9|7sus4)?\b/,chrdBlock:/\b(\S+\s*)/g,tabs:/^\s*(\|{0,2}[A-Gb]?\|{0,2}[-x0-9|:]{4,})/};_public.run=function(text){_hasChords=false;var lines=read(text);return merge(lines);};_public.hasChords=function(){return _hasChords;};var read=function(text){var lineAry=[];text=text.replace(' ','    ');var lines=text.split('\n');for(var i=0;i<lines.length;i++){var words=lines[i].match(_re.words);var l=new LineObj();l.source=lines[i];if((words!=null)&&(words.length>0)){l.wordCount=words.length;l.words=words;l.chordCount=countChords(words);}
var spaces=lines[i].match(_re.spaces);if((spaces!=null)&&(spaces.length>0)){l.spaceCount=spaces.length;}
l.lineType=toLineType(l);lineAry.push(l);}
return lineAry;};var toLineType=function(line){if((line.spaceCount+line.wordCount)<1){return _enums.lineTypes.blank;}
var tabs=line.source.match(_re.tabs);if(tabs!=null){return _enums.lineTypes.tabs;}
var t=_enums.lineTypes.lyrics;if((line.chordCount>0)&&(line.wordCount==line.chordCount)){t=_enums.lineTypes.chords;_hasChords=true;}
return t;};var countChords=function(words){var count=0;for(var i=0;i<words.length;i++){if(words[i].match(_re.chordNames)){count++;}}
return count;};var merge=function(lines){var s='';var thisLine,nextLine;for(var i=0;i<lines.length;){thisLine=lines[i];nextLine=lines[i+1];i++;if(!nextLine||(thisLine.lineType==_enums.lineTypes.blank)){s+=thisLine.source+'\n';continue;}
if((thisLine.lineType==_enums.lineTypes.tabs)&&isTabBlock(lines,i)){s+='{start_of_tab}\n'+thisLine.source.replace(_re.leadingSpace,'')+'\n'+nextLine.source.replace(_re.leadingSpace,'')+'\n'+lines[i+1].source.replace(_re.leadingSpace,'')+'\n'+lines[i+2].source.replace(_re.leadingSpace,'')+'\n'+'{end_of_tab}\n';i+=3;continue;}
if((thisLine.lineType!=_enums.lineTypes.chords)||(nextLine.lineType!=_enums.lineTypes.lyrics)){s+=(thisLine.lineType==_enums.lineTypes.chords)?wrapChords(thisLine.source)+'\n':thisLine.source+'\n';continue;}
i++;s+=mergeLines(thisLine.source,nextLine.source)+'\n';}
return s;};var isTabBlock=function(lines,index){if(index+3>=lines.length){return false;}
for(var i=index;i<index+3;i++){if(lines[i].lineType!=_enums.lineTypes.tabs){return false;}}
return true;};var mergeLines=function(chordLine,lyricsLine){while(lyricsLine.length<chordLine.length){lyricsLine+=' ';}
var s='';var blocks=chordLine.match(_re.chrdBlock);var lead=chordLine.match(_re.leadingSpace);var offset=0;if(lead){s+=lyricsLine.substr(offset,lead[0].length);offset=lead[0].length;}
for(var j=0;j<blocks.length;j++){s+='['+blocks[j].replace(_re.spaces,'')+']'+lyricsLine.substr(offset,blocks[j].length);offset+=blocks[j].length;}
if(offset<lyricsLine.length){s+=lyricsLine.substr(offset,lyricsLine.length);}
return s;};var wrapChords=function(chordLine){var chords=chordLine.replace(_re.spaces,' ').split(' ');var s='';for(var i=0;i<chords.length;i++){if(chords[i].length>0){s+='['+chords[i]+'] ';}}
return s;};return _public;}());;ugsEditorPlus.autoReformat=(function(){var _public={};var _ele={};var _formatted;var _isDisabled=false;_public.run=function(elements){if(_isDisabled){return;}
_ele=elements;_ele.reformatTextBox=document.getElementById('reformatSource');_ele.reformatDlg=document.getElementById('reformatDlg');document.getElementById('reformatYesBtn').onclick=function(){doOk();return false;};document.getElementById('reformatNoBtn').onclick=function(){doClose();return false;};var chk=document.getElementById('reformatDisable');chk.checked=false;chk.onclick=function(){doDisable(this.checked);};runNow();};var doOk=function(){_ele.cpmSource.value=_formatted;doClose();ugsEditorPlus.actions.run(true);};var doClose=function(){ukeGeeks.toolsLite.addClass(_ele.reformatDlg,'isHidden');};var doDisable=function(isDisabled){_isDisabled=isDisabled;};var runNow=function(){_formatted=ugsEditorPlus.reformat.run(_ele.cpmSource.value);_ele.reformatTextBox.innerHTML=_formatted;if(!ugsEditorPlus.reformat.hasChords()){return;}
ukeGeeks.toolsLite.removeClass(_ele.reformatDlg,'isHidden');};return _public;}());;ugsEditorPlus.topMenus=(function(){var _init=function(){$('#ugsAppToolbar > ul li').not('[data-dialog]').children('a').click(_onMenuItemClick);$('.showOptionsBox a').click(_onShowOptionsClick);$('#ugsAppToolbar > ul li[data-dialog]').click(_onShowDlgBtnClick);$('.closeBtn').click(_onCloseBtnClick);$('.resizeBtn').click(_onResizeBtnClick);};var _onMenuItemClick=function(){var $parent=$(this).parent();var isOpen=$parent.hasClass('active');_makeAllInactive();if(isOpen){return;}
$parent.addClass('active');};var _makeAllInactive=function(){$('#ugsAppToolbar > ul > li').removeClass('active');};var _closeAll=function(){_makeAllInactive();$('.arrowBox').hide();};var _onShowDlgBtnClick=function(e){_closeAll();var id=$(this).data('dialog');$('#'+id).fadeIn();return false;};var _onCloseBtnClick=function(e){$(this).parents('.overlay').fadeOut();return false;};var _onResizeBtnClick=function(e){_closeAll();var dlg=$(this).parents('.overlay');ugsEditorPlus.resize.toggle(dlg);return false;};var _onShowOptionsClick=function(e){var id=$(this).attr('href');$('.arrowBox').not(id).hide();var $dlg=$(id);$dlg.find('dd').hide();$dlg.fadeToggle();ugsEditorPlus.submenuUi.reset($dlg);return false;};return{init:_init,makeAllInactive:_makeAllInactive};}());;ugsEditorPlus.submenuUi=(function(){var _public={};var _open=null;_public.init=function(){ugsEditorPlus.themes.loadList('#colorPicker .pseudoSelect',ugsEditorPlus.options.theme);$('.enablePseudoSelects label').click(onLabelClick);$('.pseudoSelect li').click(onOptionClick);$('body').bind('click',closeAll);$('.arrowBox').click(doCollapseAllLists);syncOptions(ugsEditorPlus.options);};var onOptionClick=function(e){var $optionItem=$(this);var value=stripHash($optionItem.children().attr('href'));var $select=$optionItem.parents('dd');var id=$select.attr('id');var actionName=$select.data('action');$('#'+id).hide();setChecked($optionItem);onListActive(this,false);_open=null;$('label[for='+id+'] span').text(getLabelText(actionName,value,$optionItem));$('label[for='+id+']').parents('dt').removeClass('active');$.event.trigger('option:click',{action:actionName,value:value});return false;};var setChecked=function($item){if(!$item){return;}
$item.siblings().removeClass('checked');$item.addClass('checked');};var syncOptions=function(options){var $item,id,map=[{action:'zoomFonts',value:options.fontSize},{action:'zoomDiagrams',value:options.diagramSize},{action:'layout',value:options.diagramPosition},{action:'paper',value:options.paper},{action:'colors',value:options.theme},{action:'tuning',value:options.tuning},{action:'placement',value:options.lyricStyle}];for(var i=map.length-1;i>=0;i--){$item=$('[data-action='+map[i].action+'] a[href=#'+map[i].value+']').closest('li');id=$item.closest('dd').attr('id');setChecked($item);$('label[for='+id+'] span').text(getLabelText(map[i].action,map[i].value,$item));}};var onLabelClick=function(e){var $thisLabel=$(this);var id=$thisLabel.attr('for');setActiveLabel($thisLabel);$('#'+id).show();onListActive(this,true);if(_open!==null){$('#'+_open.id).hide();}
if(_open!==null&&_open.id==id){_open=null;}
else{_open={"id":id};}
return false;};_public.reset=function($dlg){$dlg.find('dt').removeClass('active');$dlg.find('.event-userSelecting').removeClass('event-userSelecting');};var setActiveLabel=function($label){$label.closest('dl').children('dt').removeClass('active');$label.closest('dt').addClass('active');};var onListActive=function(ele,isInUse){$(ele).parents('.enablePseudoSelects').toggleClass('event-userSelecting',isInUse);};var doCollapseAllLists=function(e){if($(e.target).is('a')){return;}
$(this).find('dd').hide();_open=null;return false;};var closeAll=function(e){$('.arrowBox').fadeOut(270);ugsEditorPlus.topMenus.makeAllInactive();};var stripHash=function(value){return(value[0]=='#')?value.substr(1):value;};var _desriptions={'zoomDiagrams':['Tiny','Small','Medium','Large','Stupid Large'],'layout':['Reference diagrams on left','Reference diagrams at top','No reference diagrams'],'placement':['Chord names inline with lyrics','Chord names above lyrics','Names & diagrams above lyrics'],'tuning':['(GCEA) Standard tuning','(DGBE) Baritone tuning','(ADF#B) alternate tuning']};var getLabelText=function(action,value,$ele){var index=$ele.index();switch(action){case'paper':return'Width '+$ele.text();case'zoomFonts':return'Font size '+value+'pt';case'zoomDiagrams':return _desriptions.zoomDiagrams[index]+' diagrams';case'colors':return ugsEditorPlus.themes.getDescription(value);case'transpose':if(value=='up_0'){return'Original key';}
var txt=$ele.text();return txt.replace(' ',' steps - "')+'"';default:return _desriptions[action][index];}};_public.resetTransposeLabel=function(){$('label[for=transposePicker] span').text('Original key');};return _public;}());;ugsEditorPlus.newSong=(function(){var _public={};var _isUpdating=false;var _ajaxUri='';_public.init=function(ajaxUri){_ajaxUri=ajaxUri;$('#newSongBtn').click(function(e){if(doValidate(this)){doPost();}});$('#openNewDlgBtn').click(function(e){resetFields();$('#newSongForm').fadeIn();$('#songTitle').focus();});$('#hideNewSongBtn').click(closeDlg);$('#newSongForm').bind('keydown',onEscape);var $spinner=$("#loadingSpinner");$spinner.hide();$(document).ajaxStart(function(){$spinner.show();_isUpdating=true;}).ajaxStop(function(){$spinner.hide();_isUpdating=false;});};var doAjaxOk=function(data){showErrors(data.HasErrors,data.Message);if(data.HasErrors){return;}
document.location.href=data.ContinueUri;};var doPost=function(){if(_isUpdating){return;}
var data={'handler':'ugs_new','songTitle':$('#songTitle').val(),'songArtist':$('#songArtist').val()};$.ajax({url:_ajaxUri,type:"POST",dataType:'json',data:JSON.stringify(data),success:function(data){doAjaxOk(data);},error:function(data){showErrors(true,'Failed to create the song file.<br/>Please have your admin check the CPM directory permissions.');}});};var doValidate=function(){var $title=$('#songTitle');var title=$title.val().trim();$title.val(title);return true;};var showErrors=function(hasErrors,message){var $err=$('#newSongForm .errorMessage');if(hasErrors){$err.show().html(message);$('#songTitle').focus();}
else{$err.hide();}};var closeDlg=function(e){$('#newSongForm').fadeOut();};var resetFields=function(){$('#songTitle, #songArtist').val('');};var onEscape=function(e){if(e.which==27){closeDlg();}};return _public;})();;ugsEditorPlus.updateSong=(function(){var _public={};var _ajaxUri='';var _filename='';var _selectors={messageBox:'#messageBox',message:'#sourceFeedback',button:'#saveBtn',spinner:'#loadingSpinner',song:'#chordProSource'};var _isUpdating=false;_public.init=function(ajaxUri,filename){_ajaxUri=ajaxUri;_filename=filename;$(_selectors.button).click(function(event){doUpdate();return false;});$(_selectors.messageBox).hide();$(document).ajaxStart(function(){showBusy();_isUpdating=true;}).ajaxStop(function(){hideMessage();_isUpdating=false;});};var showBusy=function(){$(_selectors.message).hide().html();$(_selectors.messageBox).slideDown('fast');$(_selectors.spinner).show();};var showMessage=function(message){$(_selectors.spinner).hide();$(_selectors.message).show().html(message);};var hideMessage=function(){$(_selectors.messageBox).delay(3000).fadeOut('slow');};var doUpdate=function(){if(_isUpdating){return;}
$(_selectors.message).show();var data={'handler':'ugs_update_81jr','filename':_filename,'song':$(_selectors.song).val()};$.ajax({url:_ajaxUri,type:'POST',dataType:'json',contentType:"application/json; charset=utf-8",data:JSON.stringify(data),success:function(data){doAjaxOk(data);},error:function(data){alert('Encountered a problem saving your Song. Please copy your song to another program until this issue is resolved.');}});};var doAjaxOk=function(data){showMessage(data.Message);};return _public;})();;ugsEditorPlus.typeahead=function(){var _public={};var _keysList=[];var _keysToDetailsDict={};var _scrubbedQuery='';var _regex;var _words=[];var _re={space:/\s{2,}/g,common:/([^a-z0-9]+)/gi,noise:/['`’-]/g};var listFromHtml=function(){$('li').each(function(index){var $this=$(this);var plainText=crushText($this.text());var href=$this.children('a').attr('href');var key=href.toLowerCase();var html=$this.children('a').html();html=html.replace('<strong class="','<span class="bigger ').replace('</strong>','</span>');_keysToDetailsDict[key]={html:html,searchText:plainText,code:key,href:href};_keysList.push(key);});};var crushText=function(value){return value.toLowerCase().replace(_re.noise,'').replace(_re.common,' ').replace(_re.space,' ').trim();};var _ta_source=function(query,process){_scrubbedQuery=crushText(query);_words=_scrubbedQuery.split(' ');var regGroup='';for(var i=0;i<_words.length;i++){_words[i]=_words[i].trim();if(_words[i].length>0){regGroup+=(regGroup.length>0?'|':'')+_words[i];}}
_regex=new RegExp('('+regGroup+')','gi');process(_keysList);};var _ta_updater=function(item){window.location=_keysToDetailsDict[item].href;return _keysToDetailsDict[item].searchText;};var _ta_matcher=function(item){var detailed=_keysToDetailsDict[item];for(var i=0;i<_words.length;i++){if(detailed.searchText.indexOf(_words[i])==-1){return false;}}
return true;};var _ta_sorter=function(items){return items.sort(function(a,b){return(_keysToDetailsDict[a].searchText>_keysToDetailsDict[b].searchText);});};var _ta_highligher=function(item){var $temp=$('<div/>').html(_keysToDetailsDict[item].html);$('em, .bigger',$temp).each(function(index){var $ele=$(this);var text=$ele.html();$ele.html(text.replace(_regex,"<strong>$1</strong>"));});return $temp.html();};_public.initialize=function(){listFromHtml();$('#quickSearch').typeahead({source:_ta_source,updater:_ta_updater,matcher:_ta_matcher,sorter:_ta_sorter,highlighter:_ta_highligher,minLength:2,items:50}).val('').focus();};return _public;};;ugsEditorPlus.resize=(function(){var _public={};var $dlg=null;var $aceLayer=null;var $help=null;var editor=null;var FADE_SPEED=550;var SLIDE_SPEED=400;var isBig=false;var isHelpOpen=false;var setup=function(dlgElement){$dlg=$(dlgElement);$("body").append('<div id="aceHeader"><button class="aceSideBtn" title="Show options &amp; help"><span></span><span></span><span></span></button><strong>Edit Song</strong><a href="#exit-fullscreen">Exit fullscreen</a></div><div id="aceEditor"></div><div id="aceHelp"></div>');$aceLayer=$('#aceEditor');$aceLayer.fadeOut(1);$help=$('#aceHelp');$('#aceHeader a').click(function(e){e.preventDefault();hideAce();});$('#aceHeader button').click(onShowHelpClicked);};var onShowHelpClicked=function(e){e.preventDefault();showHelp(!isHelpOpen);};var showHelp=function(isShow){isHelpOpen=isShow;if(isShow){$help.animate({left:0},SLIDE_SPEED);$aceLayer.animate({left:'350px'},SLIDE_SPEED);}
else{$help.animate({left:'-350px'},SLIDE_SPEED);$aceLayer.animate({left:0},SLIDE_SPEED);}};var getPath=function(fileName){var path='',lower,pos;fileName=fileName.toLowerCase();$('script').each(function(index,item){lower=item.src.toLowerCase();pos=lower.indexOf(fileName);if(pos>0){path=item.src.substr(0,pos);}});return path;};var showAce=function(){isBig=true;$('html').addClass('aceEditorActive');$('.overlay').fadeOut(300);if(editor!==null){copySongToAce();return;}
var path=getPath('ugsEditorPlus');LazyLoad.js(path+'/ace/ace.js',function(){editor=ace.edit("aceEditor");editor.setTheme("ace/theme/idle_fingers");editor.getSession().setMode("ace/mode/chordpro");editor.setOptions({enableBasicAutocompletion:true,enableSnippets:true});editor.completers=[ugsAce.chordCompleter];copySongToAce();$help.html(ugsAce.helpHtml);});};var copySongToAce=function(){$aceLayer.fadeIn(FADE_SPEED);editor.setValue($('#chordProSource').val());editor.gotoLine(1);$help.fadeIn(1);};var hideAce=function(){isBig=false;$dlg.show();$aceLayer.fadeOut(FADE_SPEED);$help.fadeOut(FADE_SPEED);if(editor!==null){$('#chordProSource').val(editor.getValue());}
$('html').removeClass('aceEditorActive');showHelp(false);};_public.toggle=function(dlgElement){if($dlg===null){setup(dlgElement);}
if(isBig){hideAce();}
else{showAce();}
return false;};return _public;}());;ugsEditorPlus.chordBuilder=(function(){var _public={};var _builder=null;_public.init=function(){var fingerToolImage=$('.fingerToolImage').css('background-image');ugsChordBuilder.settings.cursor.imageUri=fingerToolImage.replace(/url\("(.*)hand.png"\)/i,'$1hand-cursor.png');_builder=new ugsChordBuilder.editorUi();_builder.init();$('#cdBldOpenBtn').click(onShowDlgBtnClick);};var onShowDlgBtnClick=function(evt){evt.preventDefault();_builder.reload();var id=$(this).data('dialog');$('#'+id).fadeIn();};return _public;}());;ugsEditorPlus.songAmatic=(function(){var _public={};_public.init=function(options){var opts=mergeOptions(options);ukeGeeks.settings.opts.retainBrackets=!opts.hideChordEnclosures;$('#songSourceDlg').toggle(opts.showEditOnLoad);ukeGeeks.scriptasaurus.init(opts.useLegacyIe);ugsEditorPlus.actions.init();ugsEditorPlus.topMenus.init();ugsEditorPlus.submenuUi.init();ugsEditorPlus.optionsDlg.init();ugsEditorPlus.chordBuilder.init();ugsEditorPlus.actions.run();};var mergeOptions=function(options){var opts={hideChordEnclosures:!ukeGeeks.settings.opts.retainBrackets,sortAlphabetical:ukeGeeks.settings.opts.sortAlphabetical,ignoreCommonChords:ukeGeeks.settings.opts.ignoreCommonChords,commonChords:ukeGeeks.settings.commonChords};return $.extend(ugsEditorPlus.options,opts,(typeof options==="object")?options:{});};return _public;}());;var ugsChordBuilder=window.ugsChordBuilder||{};ugsChordBuilder.version='1.0.6';ugsChordBuilder.entities={BoundingBox:function(pos,dimensions){this.x=pos?pos.x:0;this.y=pos?pos.y:0;this.width=dimensions?dimensions.width:1;this.height=dimensions?dimensions.height:1;},Dot:function(string,fret,finger){this.string=string;this.fret=fret?fret:0;this.finger=finger?finger:0;},Position:function(x,y){this.x=x?x:0;this.y=y?y:0;}};ugsChordBuilder.settings=(function(){var ents=ugsChordBuilder.entities;var FONT_STACK='Arial, "Helvetica Neue", Helvetica, Verdana, sans-serif';var anchorPos={x:75,y:75};var cursor={fillColor:'rgba(220, 216, 73, 0.35)',strokeWidth:1,strokeColor:'#AAB444',radius:9,imageUri:'/img/editor/hand-cursor.png'};var fretBoard={numFrets:5,maxFret:16,stringNames:['G','C','E','A'],strokeWidth:4,strokeColor:'#8F8569',fretSpace:35,stringSpace:30};var dot={fillColor:'#F68014',radius:11,strokeWidth:2,strokeColor:'#D56333',fontWeight:'bold',fontFamily:FONT_STACK,fontSize:16,fontColor:'#ffffff'};var fretLabel={fontFamily:FONT_STACK,fontSize:28,color:'#6A6A63',lightColor:'#EAEAE8'};var stringLabel={fontFamily:FONT_STACK,fontSize:34,color:'#DCD849'};var chord={nameMaxLength:20};var targetDimensions=function(){return{height:fretBoard.fretSpace,width:fretBoard.stringSpace};};var targetAnchorPos=function(){var dimensions=targetDimensions();return new ents.Position(anchorPos.x-0.5*dimensions.width,anchorPos.y-dimensions.height-0.2*fretBoard.strokeWidth);};var centerAnchor=function(canvas){anchorPos.x=(0.5*canvas.width)-(0.5*(fretBoard.stringNames.length-1)*fretBoard.stringSpace)-fretBoard.strokeWidth;anchorPos.y=(0.5*canvas.height)-(0.5*fretBoard.numFrets*fretBoard.stringSpace);};return{anchorPos:anchorPos,cursor:cursor,fretBoard:fretBoard,dot:dot,fretLabel:fretLabel,stringLabel:stringLabel,chord:chord,targetDimensions:targetDimensions,targetAnchorPos:targetAnchorPos,centerAnchor:centerAnchor};}());ugsChordBuilder.tracking=(function(){var ents=ugsChordBuilder.entities,settings=ugsChordBuilder.settings;var _public={};var targetBox=null;var getTarget=function(){if(targetBox){return targetBox;}
var dimensions=settings.targetDimensions();dimensions.width=dimensions.width*settings.fretBoard.stringNames.length;dimensions.height=dimensions.height*(settings.fretBoard.numFrets+1);targetBox=new ents.BoundingBox(settings.targetAnchorPos(),dimensions);return targetBox;};var collision=function(object1,object2){return(object1.x<object2.x+object2.width)&&(object1.x+object1.width >object2.x)&&(object1.y<object2.y+object2.height)&&(object1.y+object1.height>object2.y);};_public.toDot=function(pos){var cursorBox=new ents.BoundingBox(pos);var box=getTarget();if(!collision(cursorBox,box)){return null;}
var dimensions=settings.targetDimensions();return new ents.Dot(Math.floor((pos.x-box.x)/dimensions.width),Math.floor((pos.y-box.y)/dimensions.height));};return _public;}());ugsChordBuilder.fretDots=(function(){var ents=ugsChordBuilder.entities,anchor_pos=ugsChordBuilder.settings.anchorPos,opts_board=ugsChordBuilder.settings.fretBoard,opts_dot=ugsChordBuilder.settings.dot;var _public={};var _dots=[];_public.getDots=function(){return _dots.slice();};_public.slide=function(numSteps){if(!inRange(numSteps)){return false;}
for(var i=0;i<_dots.length;i++){_dots[i].fret=_dots[i].fret+numSteps;}
return true;};var inRange=function(numSteps){for(var i=0;i<_dots.length;i++){if((_dots[i].fret+numSteps<1)||(_dots[i].fret+numSteps>opts_board.numFrets)){return false;}}
return true;};_public.toggleDot=function(dot){if(dot.fret==0){clearColumn(dot.string);return;}
var index=find(dot);if(index<0){_dots.push(dot);}
else{_dots.splice(index,1);}};_public.toggleFinger=function(dot,finger){var index=find(dot);if(index<0){return false;}
_dots[index].finger=_dots[index].finger==finger?0:finger;return true;};_public.reset=function(){for(var i=0;i<opts_board.stringNames.length;i++){clearColumn(i);}};var find=function(dot){for(var i=_dots.length-1;i>=0;i--){if(_dots[i].string==dot.string&&_dots[i].fret==dot.fret){return i;}}
return-1;};var clearColumn=function(string){for(var i=_dots.length-1;i>=0;i--){if(_dots[i].string==string){_dots.splice(i,1);}}};var getPosition=function(dot){return new ents.Position(anchor_pos.x+0.47*opts_board.strokeWidth+dot.string*opts_board.stringSpace,anchor_pos.y+0.47*opts_board.strokeWidth+(dot.fret-0.5)*opts_board.fretSpace);};var drawDot=function(context,pos){context.beginPath();context.arc(pos.x,pos.y,opts_dot.radius,0,2*Math.PI,false);context.fillStyle=opts_dot.fillColor;context.fill();context.lineWidth=opts_dot.strokeWidth;context.strokeStyle=opts_dot.strokeColor;context.stroke();};var addLabel=function(context,pos,text){context.font=opts_dot.fontWeight+' '+opts_dot.fontSize+'px '+opts_dot.fontFamily;context.textAlign='center';context.fillStyle=opts_dot.fontColor;context.fillText(text,pos.x,pos.y+0.3*opts_dot.fontSize);};_public.draw=function(context){for(var i=_dots.length-1;i>=0;i--){var pos=getPosition(_dots[i]);drawDot(context,pos);if(_dots[i].finger>0){addLabel(context,pos,_dots[i].finger);}}};return _public;}());ugsChordBuilder.cursorCanvas=(function(){var opts_cursor=ugsChordBuilder.settings.cursor,opts_dot=ugsChordBuilder.settings.dot;var _public={};var _context=null;var _handImage=null;var _imgOk=false;var _dotCursor=true;var _finger=1;var _lastPos={x:0,y:0};_public.init=function(ctx){_context=ctx;loadImage();};var erase=function(pos){var radius=opts_cursor.radius+opts_cursor.strokeWidth;_context.clearRect(pos.x-radius,pos.y-radius,radius+50,radius+60);};var drawHandCursor=function(pos){_context.drawImage(_handImage,pos.x,pos.y);_context.font=opts_dot.fontWeight+' '+opts_dot.fontSize+'px '+opts_dot.fontFamily;_context.textAlign='left';_context.fillStyle='black';_context.fillText(_finger,pos.x+0.8*_handImage.width,pos.y+_handImage.height);};var loadImage=function(){_handImage=new Image();_handImage.onload=function(){_imgOk=true;};_handImage.src=opts_cursor.imageUri;};var drawDotCursor=function(pos){_context.beginPath();_context.arc(pos.x,pos.y,opts_cursor.radius,0,2*Math.PI,false);_context.fillStyle=opts_cursor.fillColor;_context.fill();_context.lineWidth=opts_cursor.strokeWidth;_context.strokeStyle=opts_cursor.strokeColor;_context.stroke();};_public.setCursor=function(isDot,finger){_dotCursor=isDot;_finger=finger;};_public.draw=function(pos){erase(_lastPos);if(!_imgOk||_dotCursor){drawDotCursor(pos);}
else{drawHandCursor(pos);}
_lastPos=pos;};return _public;}());ugsChordBuilder.chordCanvas=(function(){var ents=ugsChordBuilder.entities,center_anchor=ugsChordBuilder.settings.centerAnchor,anchor_pos=ugsChordBuilder.settings.anchorPos,opt_fLabel=ugsChordBuilder.settings.fretLabel,opt_sLabel=ugsChordBuilder.settings.stringLabel,opts_board=ugsChordBuilder.settings.fretBoard;var _public={};var _context=null,_canvas=null;_public.init=function(ctx,ele){_context=ctx;_canvas=ele;center_anchor(_canvas);};var erase=function(){_context.clearRect(0,0,_canvas.width,_canvas.height);};var addLabel=function(text,color,pos){_context.font=opt_fLabel.fontSize+'px '+opt_fLabel.fontFamily;_context.textAlign='right';_context.fillStyle=color;_context.fillText(text,pos.x,pos.y);};var addLabels=function(startingFret){var pos=new ents.Position(anchor_pos.x-0.3*opt_fLabel.fontSize,anchor_pos.y+opt_fLabel.fontSize);var color=startingFret>1?opt_fLabel.color:opt_fLabel.lightColor;for(var i=0;i<opts_board.numFrets;i++){addLabel(startingFret+i,color,pos);pos.y+=opts_board.fretSpace;color=opt_fLabel.lightColor;}};var addStringName=function(text,pos){_context.font=opt_sLabel.fontSize+'px '+opt_sLabel.fontFamily;_context.textAlign='center';_context.fillStyle=opt_sLabel.color;_context.fillText(text,pos.x,pos.y);};var addStringNames=function(){var pos=new ents.Position(anchor_pos.x+0.5*opts_board.strokeWidth,anchor_pos.y-0.25*opt_fLabel.fontSize);for(var i=0;i<opts_board.stringNames.length;i++){addStringName(opts_board.stringNames[i],pos);pos.x+=opts_board.stringSpace;}};var drawFretboard=function(){var i,x,y;var offset=opts_board.strokeWidth/2;var stringHeight=opts_board.numFrets*opts_board.fretSpace;var fretWidth=(opts_board.stringNames.length-1)*opts_board.stringSpace;_context.beginPath();for(i=1;i<(opts_board.stringNames.length-1);i++){x=anchor_pos.x+i*opts_board.stringSpace+offset;_context.moveTo(x,anchor_pos.y+offset);_context.lineTo(x,anchor_pos.y+stringHeight+offset);}
for(i=1;i<opts_board.numFrets;i++){y=anchor_pos.y+i*opts_board.fretSpace+offset;_context.moveTo(anchor_pos.x+offset,y);_context.lineTo(anchor_pos.x+fretWidth+offset,y);}
_context.rect(anchor_pos.x+offset,anchor_pos.y+offset,fretWidth,stringHeight);_context.strokeStyle=opts_board.strokeColor;_context.lineWidth=opts_board.strokeWidth;_context.stroke();_context.closePath();};_public.draw=function(pos,startingFret){erase();addLabels(startingFret);addStringNames();drawFretboard();ugsChordBuilder.fretDots.draw(_context);};return _public;}());ugsChordBuilder.export=(function(){var opts_board=ugsChordBuilder.settings.fretBoard,opts_chord=ugsChordBuilder.settings.chord;var _public={};var _fretOffset=null;var StringDots=function(string,dots){this.string=string;this.dots=dots?dots:[];};var getStringDots=function(){var stringNumber,aryStringDots=[];for(stringNumber=1;stringNumber<=opts_board.stringNames.length;stringNumber++){aryStringDots.push(new StringDots(stringNumber));}
var dots=ugsChordBuilder.fretDots.getDots();for(stringNumber=aryStringDots.length-1;stringNumber>=0;stringNumber--){for(var i=dots.length-1;i>=0;i--){if(aryStringDots[stringNumber].string==dots[i].string+1){aryStringDots[stringNumber].dots.push(dots[i]);}}}
return aryStringDots;};var getMinMax=function(ary){var max=0;var min=900;for(var i=ary.length-1;i>=0;i--){if(ary[i].fret>max){max=ary[i].fret;}
if(ary[i].fret<min){min=ary[i].fret;}}
return{max:max,min:(min<900)?min:max};};var fretNumber=function(fret){return fret>0?_fretOffset+fret:0;};var getFinger=function(dots,fret){for(var i=0;i<dots.length;i++){if(dots[i].fret==fret){return dots[i].finger;}}
return 0;};_public.getPrimaryFrets=function(startingFret){_fretOffset=startingFret-1;var dotsPerString=getStringDots();var primaries=[];for(var i=0;i<dotsPerString.length;i++){var minMax=getMinMax(dotsPerString[i].dots);primaries.push(fretNumber(minMax.max));}
return primaries;};_public.getDefinition=function(chordName,startingFret){chordName=scrub(chordName);var name=(chordName&&chordName.length>0)?chordName:'CHORDNAME';var fretsStr='';var fingersString='';var addsString='';_fretOffset=startingFret-1;var dotsPerString=getStringDots();for(var i=0;i<dotsPerString.length;i++){var minMax=getMinMax(dotsPerString[i].dots);fretsStr+=fretNumber(minMax.max)+' ';fingersString+=getFinger(dotsPerString[i].dots,minMax.max)+' ';if(minMax.max!=minMax.min){addsString+=' add: string '+dotsPerString[i].string+' fret '+fretNumber(minMax.min)+' finger '+getFinger(dotsPerString[i].dots,minMax.min);}}
return('{define: '+name+' frets '+fretsStr+' fingers '+fingersString+addsString+'}').replace(/\s+/g,' ').replace(' }','}');};_public.getDefinitionHtml=function(chordName,startingFret){chordName=scrub(chordName);var html=_public.getDefinition(chordName,startingFret);html=html.replace(' '+chordName,' '+'X07Myq791wso01');html=html.replace(/\b(\d+)\b/g,'<span class="chordPro-X07MX001number">$1</span>');html=html.replace(/\b(frets?|fingers?|string)\b/g,'<span class="chordPro-X07MX001attribute">$1</span>');html=html.replace(/\b(define|add)\b/g,'<span class="chordPro-X07MX001keyword">$1</span>');return html.replace('X07Myq791wso01','<span class="chordPro-string">'+chordName+'</span>').replace(/X07MX001/g,'').replace(/ +/g,' ');};var scrub=function(name){var disallow=/^(frets|fingers|add:)$/i;var cleaned=name.replace(/^\s*(.*?)\s*$/,'$1').replace(/\s+/g,'-');if(disallow.test(cleaned)){cleaned='';}
return cleaned.substring(0,opts_chord.nameMaxLength);};return _public;}());;ugsChordBuilder.chooserList=(function(){var _public={};var _chordDictionary=[];var _eleChordList=null;var C_NEW_CHORD=-1;var _nextId=0;var _ids={source:'chordProSource',chordList:'cdBldPick',builderPanel:'cdBldBuilderPanel',chooserPanel:'cdBldChooserPanel'};var _currentChord=null;var _setChordMethod=function(){};var _ugsBrushTool=null;var _diagramSettings={dimensions:{showText:false,height:50,width:40,fretSpace:9,stringSpace:7,dotRadius:3,lineWidth:1,topLeftPos:{x:10,y:2},xWidth:0.7*7,xStroke:1.4*1},fonts:{dot:'8pt Arial',text:'8pt Arial',fret:'8pt Arial'},colors:{fretLines:'#EED18E',dots:'#551D00',dotText:'#ffffff',text:'#000000',fretText:'#EED18E',xStroke:'#551D00'}};var ChordDefinition=function(name,definition){this.id=_nextId++;this.name=name;this.definition=definition;};_public.init=function(setChordFunction){_setChordMethod=setChordFunction;_eleChordList=document.getElementById(_ids.chordList);_eleChordList.addEventListener('click',onClick,false);_start();};var _start=function(){songGetDefinitions(document.getElementById(_ids.source).value);listLoad(_eleChordList,_chordDictionary);};_public.reset=function(){_chordDictionary=[];document.getElementById(_ids.chordList).innerHTML='';_nextId=0;_currentChord=null;_start();};_public.show=function(isChooserPanel){document.getElementById(_ids.chooserPanel).style.display=isChooserPanel?'block':'none';document.getElementById(_ids.builderPanel).style.display=!isChooserPanel?'block':'none';$('#'+_ids.chooserPanel).closest('.overlay').toggleClass('chordBuilderNarrow',isChooserPanel);};_public.save=function(data){if(dictionaryFindDupes(_currentChord==null?-1:_currentChord.id,data.name)>=0){alert('Hey, this chord name is already being used.');return false;}
var id=-1;if(_currentChord==null){id=definitionAdd(data.name,data.definition);_currentChord=dictionaryFind(id);songAddDefinition(data.definition);}
else{var i=dictionaryGetIndex(_currentChord.id);if(i<0){return false;}
var oldDefinition=_chordDictionary[i].definition;_chordDictionary[i].name=data.name;_chordDictionary[i].definition=data.definition;id=_chordDictionary[i].id;songReplace(oldDefinition,_chordDictionary[i].definition);}
listUpdate(id);_public.show(true);return true;};var doDelete=function(chord){if(!confirm('Delete definition for "'+chord.name+'"?')){return;}
var item=listGetItem(chord.id);if(!item){return;}
_eleChordList.removeChild(item);songReplace(chord.definition,'');};var onClick=function(evt){evt.preventDefault();_currentChord=dictionaryFind(evt.target.getAttribute('data-id'));if(evt.target.getAttribute('data-action')=='delete'){doDelete(_currentChord);return;}
var chord=null;if(_currentChord!=null){chord=ukeGeeks.chordImport.runLine(_currentChord.definition);if(hasMutedStrings(chord)){alert('Uh-oh! This chord uses muted strings!\nCurrently the Chord Builder does not support muted strings -- \nsaving edits will result in mutes being lost.');}}
_setChordMethod(chord);_public.show(false);};var hasMutedStrings=function(chord){if(chord.muted){for(var i=0;i<chord.muted.length;i++){if(chord.muted[i]){return true;}}}
return false;};var listUpdate=function(id){var def=dictionaryFind(id);var item=listGetItem(id);if(!item){item=listAddItem(id,def.name);}
else{item.innerHTML=listHtmlString(id,def.name,true);}
listAddDiagram(id);return item;};var listGetItem=function(id){var items=_eleChordList.getElementsByTagName('li');for(var i=0;i<items.length;i++){if(items[i].getAttribute('data-id')==(''+id)){return items[i];}}
return null;};var listHtmlString=function(id,name,isInner){isInner=(arguments.length>2)?isInner:false;var innerHtml='<span class="deleteChord" data-id="'+id+'" data-action="delete" title="Remove this definition"></span>'+name;return isInner?innerHtml:'<li data-id="'+id+'" title="Edit this definition" class="ugs-grouped">'+innerHtml+'</li>';};var listLoad=function(ul,chordDefs){var i,s='';for(i=0;i<chordDefs.length;i++){s+=listHtmlString(chordDefs[i].id,chordDefs[i].name);}
ul.innerHTML='<li data-id="'+C_NEW_CHORD+'" class="newChord">+ Add New Chord</li>'+s;var items=ul.getElementsByTagName('li');for(i=items.length-1;i>=0;i--){if(i<1){continue;}
listAddDiagram(items[i].getAttribute('data-id'));}};var listAddItem=function(id,name){var temp=document.createElement('ul');temp.innerHTML=listHtmlString(id,name);_eleChordList.appendChild(temp.childNodes[0]);};var listAddDiagram=function(id){var element=listGetItem(id);var defintion=dictionaryFind(id);var chord=ukeGeeks.chordImport.runLine(defintion.definition);if(_ugsBrushTool==null){_ugsBrushTool=new ukeGeeks.chordBrush();}
_ugsBrushTool.plot(element,chord,_diagramSettings.dimensions,_diagramSettings.fonts,_diagramSettings.colors);};var replaceAll=function(text,searchValue,newValue){var newText=text.replace(searchValue,newValue);return(newText==text)?text:replaceAll(newText,searchValue,newValue);};var songReplace=function(oldDefinition,newDefinition){var e=document.getElementById(_ids.source);e.value=replaceAll(e.value,oldDefinition,newDefinition);ugsEditorPlus.actions.run();};var songGetDefinitions=function(text){var defineRegEx=/\{define:\s*([^}]+?)\s+frets[^}]+?\}/im;var lines=text.split('\n');for(var i=lines.length-1;i>=0;i--){if(!defineRegEx.test(lines[i])){continue;}
definitionAdd(lines[i].replace(defineRegEx,'$1'),lines[i]);}};var songAddDefinition=function(definition){var choProText=document.getElementById(_ids.source);var instructionRegEx=/\s*\{\s*(title|t|artist|subtitle|st|album|define):.*?\}/im;var lines=choProText.value.split('\n');var html='';var inserted=false;for(var i=lines.length-1;i>=0;i--){if(!inserted&&instructionRegEx.test(lines[i])){html=definition+'\n'+html;inserted=true;}
html=lines[i]+'\n'+html;}
if(!inserted){html=definition+'\n'+choProText.value;}
choProText.value=html;ugsEditorPlus.actions.run();};var dictionaryGetIndex=function(id){for(var i=0;i<_chordDictionary.length;i++){if(''+_chordDictionary[i].id==id){return i;}}
return-1;};var dictionaryFindDupes=function(id,name){var search=name.toLowerCase();for(var i=_chordDictionary.length-1;i>=0;i--){if((''+_chordDictionary[i].id!=''+id)&&(_chordDictionary[i].name.toLowerCase()==search)){return i;}}
return-1;};var dictionaryFind=function(id){var i=dictionaryGetIndex(id);return i>=0?_chordDictionary[i]:null;};var definitionAdd=function(name,definition){var chord=new ChordDefinition(name,definition);_chordDictionary.push(chord);return chord.id;};return _public;}());;ugsChordBuilder.editorUi=function(){var _ids={container:'cdBldEditorSurface',cursorCanvas:'cdBldCursorCanvas',diagramCanvas:'cdBldDiagramCanvas',startingFret:'cdBldStartingFret',chordName:'cdBldChordName',toolbox:'cdBldToolbox',dotsBtn:'cdBldDotsBtn',fingersBtn:'cdBldFingersBtn',slideUpBtn:'toolboxSlideUpBtn',slideDownBtn:'toolboxSlideDownBtn',btnFingerName:'cdBldBtnFingerName',btnHandPic:'cdBldBtnDiagram',output:'cdBldOutput',showOutputBtn:'cdBldShowOutputBtn',outputBox:'cdBldOutputBox',cancelBtn:'cdBldCancelBtn',saveBtn:'cdBldSaveBtn'};var _cursorCanvas=null,_eleDotsBtn=null,_eleFingerBtn=null;var _startingFret=1;var _currentName='';var _isDotToolActive=true;var _finger=0;var _fingerNames={0:'None',1:'Index finger',2:'Middle finger',3:'Ring finger',4:'Pinkie'};this.init=function(){_cursorCanvas=document.getElementById(_ids.cursorCanvas);if(!_cursorCanvas.getContext){return false;}
var cursorContext=_cursorCanvas.getContext('2d');var diagramContext=document.getElementById(_ids.diagramCanvas).getContext('2d');var ele=document.getElementById(_ids.startingFret);addStartingFretOptions(ele);ele.addEventListener('change',onFretChange,false);document.getElementById(_ids.chordName).addEventListener('keyup',onNameChange,false);_eleDotsBtn=document.getElementById(_ids.dotsBtn);_eleFingerBtn=document.getElementById(_ids.fingersBtn);_eleDotsBtn.addEventListener('click',toggleTool,false);_eleFingerBtn.addEventListener('click',toggleTool,false);document.getElementById(_ids.showOutputBtn).addEventListener('click',showOutputBox,false);document.getElementById(_ids.cancelBtn).addEventListener('click',onCancelClick,false);document.getElementById(_ids.saveBtn).addEventListener('click',onSaveClick,false);document.getElementById(_ids.slideUpBtn).addEventListener('click',slide,false);document.getElementById(_ids.slideDownBtn).addEventListener('click',slide,false);updateFinger();document.getElementById(_ids.container).addEventListener('mousemove',onMouseMove,false);_cursorCanvas.addEventListener('click',onMouseClick,false);ugsChordBuilder.chordCanvas.init(diagramContext,_cursorCanvas);ugsChordBuilder.cursorCanvas.init(cursorContext);redraw();exportDefinition();ugsChordBuilder.chooserList.init(setChord);return true;};var updateFinger=function(){_finger++;if(_finger>4){_finger=0;}
document.getElementById(_ids.btnFingerName).innerHTML=_fingerNames[_finger]+' ('+_finger+')';document.getElementById(_ids.btnHandPic).className='fingerToolImage finger'+_finger;};var showOutputBox=function(evt){setClass(document.getElementById(_ids.outputBox),'collapseOutput',!evt.target.checked);};var onCancelClick=function(evt){evt.preventDefault();reset();ugsChordBuilder.chooserList.show(true);};var onSaveClick=function(evt){evt.preventDefault();var d={name:_currentName,startingFret:_startingFret,dots:ugsChordBuilder.fretDots.getDots(),definition:ugsChordBuilder.export.getDefinition(_currentName,_startingFret)};if(!ugsChordBuilder.chooserList.save(d)){var e=document.getElementById(_ids.chordName);e.focus();e.select();}};var setChord=function(chord){var isNew=chord==null;if(isNew){reset();return;}
var maxFret=findMaxFret(chord.dots);var startingFret=(maxFret>ugsChordBuilder.settings.fretBoard.numFrets)?maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1:1;reset(chord.name,startingFret,convertDots(startingFret,chord.dots),false);};var convertDots=function(startingFret,builderDots){var offset=startingFret-1;var ugsDots=[];for(var i=0;i<builderDots.length;i++){var fret=builderDots[i].fret-offset;ugsDots.push(new ugsChordBuilder.entities.Dot(builderDots[i].string,(fret<0?0:fret),builderDots[i].finger));}
return ugsDots;};var findMaxFret=function(dots){var max=0;for(var i=0;i<dots.length;i++){if(dots[i].fret>max){max=dots[i].fret;}}
return max;};var resetInputs=function(name,startingFret,isNew){_currentName=(name&&name.length>0)?name:'CHORDNAME';document.getElementById(_ids.chordName).value=_currentName;_startingFret=startingFret?startingFret:1;document.getElementById(_ids.startingFret).value=_startingFret;document.getElementById(_ids.showOutputBtn).checked=false;setClass(document.getElementById(_ids.outputBox),'collapseOutput',true);document.getElementById(_ids.saveBtn).value=isNew?'Add':'Update';};var resetCurrentTool=function(){_isDotToolActive=true;_finger=0;updateFinger();setClass(_eleDotsBtn,'selected',_isDotToolActive);setClass(_eleFingerBtn,'selected',!_isDotToolActive);setClass(document.getElementById(_ids.toolbox),'open',!_isDotToolActive);ugsChordBuilder.cursorCanvas.setCursor(_isDotToolActive,_finger);};var reset=function(name,startingFret,dots,isNew){isNew=arguments.length>3?isNew:true;ugsChordBuilder.fretDots.reset();resetInputs(name,startingFret,isNew);resetCurrentTool();if(dots&&dots.length>0){for(var i=0;i<dots.length;i++){ugsChordBuilder.fretDots.toggleDot(dots[i]);}}
redraw();exportDefinition();};var toggleTool=function(evt){evt.preventDefault();var useDotTool=evt.currentTarget.href.indexOf('#dots')>=0;if(useDotTool==_isDotToolActive){if(!useDotTool){updateFinger();ugsChordBuilder.cursorCanvas.setCursor(_isDotToolActive,_finger);}
return;}
setClass(_eleDotsBtn,'selected',useDotTool);setClass(_eleFingerBtn,'selected',!useDotTool);setClass(document.getElementById(_ids.toolbox),'open',!useDotTool);_isDotToolActive=useDotTool;ugsChordBuilder.cursorCanvas.setCursor(_isDotToolActive,_finger);};var setClass=function(element,className,isSet){var hasClass=element.className.indexOf(className)>=0;if(isSet&&!hasClass){element.className+=' '+className;}
else if(!isSet&&hasClass){element.className=element.className.replace(className,'').replace(/\s+/g,' ');}};var addStartingFretOptions=function(ele){var s='';var lastValue=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1;for(var i=1;i<=lastValue;i++){s+='<option value="'+i+'">'+i+'</option>';}
ele.innerHTML=s;};var onNameChange=function(evt){_currentName=this.value;exportDefinition();};var onFretChange=function(evt){_startingFret=parseInt(this.value,10);exportDefinition();redraw();};var slide=function(evt){evt.preventDefault();var moveAllowed=false;var numSteps=evt.target.getAttribute('data-direction')=='up'?-1:+1;if(ugsChordBuilder.fretDots.slide(numSteps)){moveAllowed=true;}
else{var newStart=_startingFret+numSteps;var lastValue=ugsChordBuilder.settings.fretBoard.maxFret-ugsChordBuilder.settings.fretBoard.numFrets+1;if((newStart>=1)&&(newStart<=lastValue)){_startingFret=newStart;document.getElementById(_ids.startingFret).value=newStart;moveAllowed=true;}}
if(moveAllowed){redraw();exportDefinition();}};var onMouseMove=function(evt){ugsChordBuilder.cursorCanvas.draw(getPosition(this,evt));};var onMouseClick=function(evt){var pos=getPosition(_cursorCanvas,evt);var dot=ugsChordBuilder.tracking.toDot(pos);if(!dot){return;}
if(_isDotToolActive){ugsChordBuilder.fretDots.toggleDot(dot);redraw(pos);exportDefinition();}
else if(ugsChordBuilder.fretDots.toggleFinger(dot,_finger)){redraw(pos);exportDefinition();}};var getPosition=function(canvas,evt){var rect=canvas.getBoundingClientRect();return new ugsChordBuilder.entities.Position(evt.clientX-rect.left,evt.clientY-rect.top);};var redraw=function(pos){pos=pos||new ugsChordBuilder.entities.Position(0,0);ugsChordBuilder.chordCanvas.draw(pos,_startingFret);};var exportDefinition=function(){document.getElementById(_ids.output).innerHTML=ugsChordBuilder.export.getDefinitionHtml(_currentName,_startingFret);};this.reload=function(){reset();ugsChordBuilder.chooserList.reset();ugsChordBuilder.chooserList.show(true);};};
